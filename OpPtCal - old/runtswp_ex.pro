 pro runtswp_ex
  ; Example script for threshold sweep fitting

  ; example data
  thresholds = [70900.0, 79100.0, 114000.0, 171000.0, 202000.0, 242000.0, 294000.0, 361000.0, 455000.0, 595000.0, 763000.0, 1080000.0, 2990000.0, 3620000.0, 3650000.0]
  N =      [[ 64716.0,  53253.0,  38444.0,  30919.0,  28841.0,  26750.0,  25284.0,  23895.0,  22687.0, 22212.0,  22045.0,  21649.0,  17623.0,  15993.0,  15814.0],$
            [ 59043.0,  52749.0,  41296.0,  32075.0,  29046.0,  26538.0,  24179.0,  23636.0,  23056.0, 23011.0,  22028.0,  21593.0,  15238.0,  12585.0,  12471.0],$
            [ 73649.0,  65014.0,  49155.0,  37636.0,  33684.0,  29921.0,  27487.0,  25904.0,  24994.0, 24596.0,  23835.0,  23352.0,  17380.0,  15245.0,  15040.0],$
            [ 59807.0,  54282.0,  41385.0,  31278.0,  28069.0,  25615.0,  23855.0,  23014.0,  21823.0, 21599.0,  20881.0,  20294.0,  14267.0,  11919.0,  11905.0],$
            [ 50546.0,  45399.0,  34529.0,  26902.0,  24459.0,  23326.0,  22614.0,  22374.0,  21819.0, 21389.0,  20491.0,  19301.0,  10639.0,   8563.0,   8436.0],$
            [ 44427.0,  39221.0,  29651.0,  23443.0,  21543.0,  20145.0,  19768.0,  19539.0,  18888.0, 18040.0,  17585.0,  16708.0,   9699.0,   7667.0,   7444.0],$
            [ 39679.0,  35921.0,  27571.0,  22156.0,  21066.0,  20603.0,  20061.0,  19643.0,  19506.0, 18589.0,  17786.0,  16467.0,   8377.0,   5563.0,   5146.0],$
            [ 32933.0,  29403.0,  23193.0,  20207.0,  19889.0,  19257.0,  18964.0,  18365.0,  17639.0, 16473.0,  15133.0,  12889.0,   3874.0,   2546.0,   2565.0],$
            [ 35213.0,  31876.0,  24767.0,  20772.0,  19841.0,  19247.0,  18966.0,  18507.0,  18274.0, 17190.0,  16396.0,  14394.0,   5576.0,   4439.0,   4474.0],$
            [ 40984.0,  36605.0,  28091.0,  22851.0,  21982.0,  21128.0,  20709.0,  20229.0,  19913.0, 19135.0,  18043.0,  16638.0,   7625.0,   5687.0,   5761.0],$
            [ 43586.0,  39272.0,  30213.0,  23469.0,  21925.0,  20980.0,  19970.0,  19544.0,  18959.0, 18961.0,  17887.0,  16883.0,   9753.0,   7946.0,   7831.0],$
            [ 44164.0,  39712.0,  30206.0,  22999.0,  21308.0,  19776.0,  18902.0,  18232.0,  17804.0, 17626.0,  17038.0,  16328.0,  10918.0,   8845.0,   8565.0],$
            [ 55071.0,  48830.0,  37041.0,  28280.0,  25844.0,  23640.0,  21770.0,  20942.0,  20406.0, 20018.0,  19395.0,  18592.0,  13257.0,  11142.0,  11043.0],$
            [ 50307.0,  45075.0,  34598.0,  26052.0,  23757.0,  21587.0,  20057.0,  18929.0,  18409.0, 18231.0,  17828.0,  17087.0,  12164.0,  10234.0,   9944.0],$
            [ 51011.0,  45693.0,  35528.0,  27145.0,  25253.0,  22857.0,  21853.0,  20507.0,  19922.0, 19484.0,  19339.0,  18386.0,  12909.0,  10929.0,  10717.0],$
            [ 47406.0,  41502.0,  33114.0,  27553.0,  26081.0,  24297.0,  22895.0,  21671.0,  21042.0, 20604.0,  20252.0,  19949.0,  14631.0,  12644.0,  12345.0]]
            
   aaxt = [0.024,0.008]

   tfit = thrswp_fit(TRANSPOSE(N), thresholds, aaxt)
   
   print, 'Residual:',tfit.R2

   px = 3
   trs_model  = DINDGEN(100)/99.0*5 + 3 ; generate thresholds between 1e3 and 1e8 for modeled curve
   trs_model = 10^trs_model 
   N_model_px = counts(trs_model,tfit.lim0crs,tfit.gammas,tfit.qs,aaxt,px)  ; obtain modeled curve from fit parameters
   N_model_px = 10^N_model_px
   p = plot(thresholds,N[*,px],'k*',/YLOG,/XLOG)
   p = plot(trs_model,N_model_px,'k-',/YLOG,/XLOG,/OVERPLOT,YRANGE=[1e3,1e6])
   
   end
